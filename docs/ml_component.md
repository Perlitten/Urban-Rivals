# Проектирование ML-компонента и требования к данным

## Общая архитектура ML-компонента

ML-компонент является ключевым элементом консультанта для Urban Rivals, обеспечивающим интеллектуальные рекомендации и аналитику. Архитектура ML-компонента построена на принципах модульности, локальной обработки и адаптивности.

### Структура ML-компонента

```
+----------------------------------------------------------+
|                     ML-ЯДРО                              |
+----------------------------------------------------------+
|                                                          |
|  +----------------+  +----------------+  +-------------+  |
|  |                |  |                |  |             |  |
|  | Боевой анализ  |  | Анализ колод   |  | Рыночный    |  |
|  | и предсказания |  | и рекомендации |  | анализ      |  |
|  |                |  |                |  |             |  |
|  +-------+--------+  +--------+-------+  +------+------+  |
|          |                    |                 |         |
+----------|--------------------|-----------------|---------+
           |                    |                 |
           v                    v                 v
+----------------------------------------------------------+
|                   СЛОЙ МОДЕЛЕЙ                           |
+----------------------------------------------------------+
|                                                          |
|  +----------------+  +----------------+  +-------------+  |
|  | Классификаторы |  | Рекомендатель- |  | Регрессион- |  |
|  | карт и         |  | ные системы    |  | ные модели  |  |
|  | стратегий      |  |                |  |             |  |
|  +-------+--------+  +--------+-------+  +------+------+  |
|          |                    |                 |         |
+----------|--------------------|-----------------|---------+
           |                    |                 |
           v                    v                 v
+----------------------------------------------------------+
|                   СЛОЙ ДАННЫХ                            |
+----------------------------------------------------------+
|                                                          |
|  +----------------+  +----------------+  +-------------+  |
|  | База данных    |  | Пользователь-  |  | Временные   |  |
|  | карт и         |  | ская статистика|  | ряды и      |  |
|  | механик        |  |                |  | тренды      |  |
|  +----------------+  +----------------+  +-------------+  |
|                                                          |
+----------------------------------------------------------+
```

## Модели машинного обучения

### 1. Модели для боевого анализа

#### 1.1. Классификатор оптимальных карт
- **Тип**: Многоклассовый классификатор
- **Входные данные**: 
  - Текущие карты в руке игрока
  - Известные карты противника
  - Текущий счет и жизни
  - История предыдущих ходов
- **Выходные данные**: 
  - Ранжированный список карт с вероятностями успеха
  - Рекомендуемое количество "пилюль" для каждой карты
- **Архитектура**: Ансамбль из градиентного бустинга и нейронной сети
- **Размер модели**: ~5-10 МБ (квантизированная версия)

#### 1.2. Предиктор ходов противника
- **Тип**: Вероятностная модель
- **Входные данные**:
  - История предыдущих ходов противника
  - Известные карты противника
  - Текущая игровая ситуация
- **Выходные данные**:
  - Вероятностное распределение возможных ходов противника
- **Архитектура**: Рекуррентная нейронная сеть (LSTM)
- **Размер модели**: ~3-7 МБ (квантизированная версия)

#### 1.3. Оценщик вероятности победы
- **Тип**: Регрессионная модель
- **Входные данные**:
  - Текущее состояние игры
  - Оставшиеся карты
  - Статистика предыдущих ходов
- **Выходные данные**:
  - Вероятность победы (0-100%)
  - Факторы, влияющие на вероятность
- **Архитектура**: Градиентный бустинг (XGBoost)
- **Размер модели**: ~2-5 МБ

### 2. Модели для анализа колод

#### 2.1. Рекомендательная система карт
- **Тип**: Коллаборативная фильтрация + контентная фильтрация
- **Входные данные**:
  - Текущая коллекция карт пользователя
  - История успешных колод
  - Метаданные карт (клан, способности, редкость)
- **Выходные данные**:
  - Рекомендации по оптимальным комбинациям карт
  - Оценка синергии между картами
- **Архитектура**: Гибридная рекомендательная система
- **Размер модели**: ~8-15 МБ

#### 2.2. Классификатор стратегий колод
- **Тип**: Многоклассовый классификатор
- **Входные данные**:
  - Состав колоды
  - Метаданные карт
- **Выходные данные**:
  - Определение типа стратегии колоды
  - Сильные и слабые стороны
  - Рекомендации по улучшению
- **Архитектура**: Сверточная нейронная сеть (CNN)
- **Размер модели**: ~4-8 МБ

### 3. Модели для рыночного анализа

#### 3.1. Предиктор цен на карты
- **Тип**: Модель временных рядов
- **Входные данные**:
  - История цен на карты
  - События в игре (обновления, турниры)
  - Популярность карт в метагейме
- **Выходные данные**:
  - Прогноз изменения цен
  - Рекомендации по покупке/продаже
- **Архитектура**: ARIMA + нейронная сеть (гибридная модель)
- **Размер модели**: ~5-10 МБ

#### 3.2. Оптимизатор покупок
- **Тип**: Оптимизационная модель
- **Входные данные**:
  - Бюджет пользователя
  - Текущие цены на карты
  - Приоритеты пользователя
  - Текущая коллекция
- **Выходные данные**:
  - Оптимальный план покупок
  - Ожидаемое улучшение колод
- **Архитектура**: Линейное программирование + эвристики
- **Размер модели**: ~1-3 МБ

## Требования к данным

### 1. База данных карт

#### 1.1. Структура данных карт
```json
{
  "card_id": "string",
  "name": "string",
  "clan": "string",
  "rarity": "string",
  "power": {
    "level_1": "number",
    "level_2": "number",
    "level_3": "number",
    "level_4": "number",
    "level_5": "number"
  },
  "damage": {
    "level_1": "number",
    "level_2": "number",
    "level_3": "number",
    "level_4": "number",
    "level_5": "number"
  },
  "ability": {
    "description": "string",
    "activation_level": "number",
    "type": "string",
    "effect": "string"
  },
  "release_date": "date",
  "image_url": "string",
  "market_data": {
    "current_price": "number",
    "price_history": [
      {
        "date": "date",
        "price": "number"
      }
    ],
    "availability": "boolean"
  }
}
```

#### 1.2. Источники данных о картах
- Парсинг официального сайта Urban Rivals
- Сообщество и вики Urban Rivals
- Анализ игрового клиента
- Пользовательские отчеты

#### 1.3. Объем и обновление
- Начальная база: ~2000+ карт
- Регулярные обновления при выходе новых карт
- Размер базы: ~5-10 МБ (включая изображения в сжатом формате)

### 2. Данные о боях

#### 2.1. Структура данных боя
```json
{
  "battle_id": "string",
  "timestamp": "date",
  "player": {
    "deck": ["card_id_1", "card_id_2", "card_id_3", "card_id_4"],
    "initial_life": "number"
  },
  "opponent": {
    "deck": ["card_id_1", "card_id_2", "card_id_3", "card_id_4"],
    "initial_life": "number"
  },
  "rounds": [
    {
      "round_number": "number",
      "player_card": {
        "card_id": "string",
        "power_used": "number",
        "ability_activated": "boolean"
      },
      "opponent_card": {
        "card_id": "string",
        "power_used": "number",
        "ability_activated": "boolean"
      },
      "winner": "string",
      "damage_dealt": "number"
    }
  ],
  "result": {
    "winner": "string",
    "player_remaining_life": "number",
    "opponent_remaining_life": "number"
  },
  "game_mode": "string"
}
```

#### 2.2. Сбор данных о боях
- Локальное отслеживание боев пользователя
- Анонимизированные данные сообщества (опционально)
- Симуляция боев для обучения моделей

#### 2.3. Объем и хранение
- Хранение последних ~1000 боев пользователя
- Агрегированная статистика без ограничения по времени
- Примерный размер: ~2-5 МБ на 1000 боев

### 3. Данные о рынке

#### 3.1. Структура данных рынка
```json
{
  "market_snapshot": {
    "timestamp": "date",
    "cards": [
      {
        "card_id": "string",
        "min_price": "number",
        "avg_price": "number",
        "max_price": "number",
        "volume": "number"
      }
    ]
  },
  "user_market_activity": {
    "purchases": [
      {
        "card_id": "string",
        "price": "number",
        "timestamp": "date"
      }
    ],
    "sales": [
      {
        "card_id": "string",
        "price": "number",
        "timestamp": "date"
      }
    ],
    "watchlist": ["card_id_1", "card_id_2"]
  }
}
```

#### 3.2. Сбор рыночных данных
- Периодический мониторинг рынка игры
- Отслеживание транзакций пользователя
- Анализ трендов и сезонных колебаний

#### 3.3. Объем и обновление
- Ежедневные снимки рынка
- Хранение истории цен за последние 3 месяца
- Примерный размер: ~1-3 МБ на месяц данных

## Процесс обучения моделей

### 1. Предварительное обучение

#### 1.1. Подготовка данных
- Сбор и очистка исторических данных о картах, боях и ценах
- Аугментация данных для редких сценариев
- Нормализация и кодирование признаков

#### 1.2. Обучение базовых моделей
- Использование Python с TensorFlow/PyTorch для начального обучения
- Оптимизация гиперпараметров через кросс-валидацию
- Конвертация моделей в формат ONNX для использования в браузере

#### 1.3. Квантизация и оптимизация
- Сокращение размера моделей через квантизацию
- Оптимизация для выполнения в браузерной среде
- Тестирование производительности на различных устройствах

### 2. Инкрементальное обучение

#### 2.1. Локальная персонализация
- Дообучение моделей на данных конкретного пользователя
- Адаптация к индивидуальному стилю игры
- Сохранение персонализированных весов локально

#### 2.2. Механизм обновления
- Периодическое обновление базовых моделей
- Слияние персонализированных изменений с обновлениями
- Версионирование моделей для совместимости

#### 2.3. Оценка качества
- Мониторинг точности предсказаний
- A/B тестирование новых версий моделей
- Сбор обратной связи от пользователей

## Интеграция ML-компонента

### 1. Интеграция с игровым процессом

#### 1.1. Захват состояния игры
- Использование MutationObserver для отслеживания изменений DOM
- Распознавание карт и игровых элементов через компьютерное зрение
- Извлечение текстовой информации через OCR

#### 1.2. Генерация рекомендаций в реальном времени
- Предварительная загрузка моделей при старте игры
- Асинхронное выполнение инференса в Web Workers
- Буферизация результатов для снижения задержки

#### 1.3. Визуализация рекомендаций
- Наложение подсказок на игровой интерфейс
- Адаптивное отображение в зависимости от размера экрана
- Анимированные переходы для улучшения восприятия

### 2. Интеграция с конструктором колод

#### 2.1. Анализ существующих колод
- Сканирование доступных карт пользователя
- Оценка эффективности текущих колод
- Выявление слабых мест и потенциальных улучшений

#### 2.2. Генерация рекомендаций по колодам
- Создание оптимальных комбинаций карт
- Учет предпочтений пользователя и стиля игры
- Объяснение логики рекомендаций

### 3. Интеграция с рыночным анализом

#### 3.1. Мониторинг рынка
- Периодическое сканирование цен на карты
- Выявление аномалий и выгодных предложений
- Отслеживание трендов и сезонных колебаний

#### 3.2. Рекомендации по покупкам
- Приоритизация карт на основе текущих колод
- Оптимизация расходования внутриигровой валюты
- Прогнозирование изменений цен

## Оптимизация производительности

### 1. Стратегии оптимизации

#### 1.1. Ленивая загрузка моделей
- Загрузка только необходимых моделей по мере надобности
- Выгрузка неиспользуемых моделей для экономии памяти
- Предварительная загрузка часто используемых моделей

#### 1.2. Кэширование результатов
- Сохранение результатов инференса для похожих ситуаций
- Инкрементальное обновление предсказаний
- Приоритизация вычислений для критических сценариев

#### 1.3. Адаптивное использование ресурсов
- Определение доступных ресурсов устройства
- Масштабирование сложности моделей в зависимости от мощности
- Балансировка между точностью и производительностью

### 2. Мониторинг производительности

#### 2.1. Метрики производительности
- Время инференса для различных моделей
- Использование памяти и CPU
- Задержка между действием пользователя и рекомендацией

#### 2.2. Автоматическая оптимизация
- Динамическая настройка параметров в зависимости от производительности
- Деградация функциональности на слабых устройствах
- Уведомления пользователя о проблемах производительности

## Требования к данным для разработки

### 1. Набор данных для начального обучения

#### 1.1. Данные о картах
- Полная база данных всех карт Urban Rivals
- Изображения карт для визуального распознавания
- Метаданные о способностях, кланах и взаимодействиях

#### 1.2. Данные о боях
- Записи реальных боев (минимум 10,000)
- Симулированные бои для редких сценариев
- Аннотированные примеры оптимальных ходов

#### 1.3. Рыночные данные
- Исторические цены на карты (минимум за 6 месяцев)
- Данные о популярности карт в метагейме
- Информация о событиях, влияющих на цены

### 2. Инструменты для сбора данных

#### 2.1. Скрапер игрового сайта
- Автоматический сбор информации о новых картах
- Мониторинг изменений в правилах и механиках
- Отслеживание официальных новостей и обновлений

#### 2.2. Логгер боев
- Запись деталей каждого боя пользователя
- Структурирование данных для обучения
- Анонимизация чувствительной информации

#### 2.3. Монитор рынка
- Периодический сбор цен на карты
- Анализ трендов и аномалий
- Отслеживание объемов торгов

### 3. Валидация и тестирование

#### 3.1. Метрики оценки моделей
- Точность предсказания оптимальных ходов
- Процент выигрышей при следовании рекомендациям
- Точность прогнозирования цен на карты

#### 3.2. Тестовые сценарии
- Набор стандартных игровых ситуаций для оценки моделей
- Сложные краевые случаи для проверки робастности
- Сценарии с новыми картами для оценки обобщающей способности

#### 3.3. Пользовательское тестирование
- A/B тестирование различных версий моделей
- Сбор обратной связи о качестве рекомендаций
- Оценка удобства использования интерфейса

## Этические аспекты и ограничения

### 1. Честная игра

#### 1.1. Соблюдение правил игры
- Отсутствие автоматизации игрового процесса
- Только рекомендации, без автоматического принятия решений
- Соответствие политике Urban Rivals относительно сторонних инструментов

#### 1.2. Прозрачность для пользователя
- Четкое объяснение логики рекомендаций
- Указание на вероятностный характер предсказаний
- Возможность отключения отдельных функций

### 2. Конфиденциальность

#### 2.1. Локальная обработка данных
- Отсутствие передачи персональных данных на серверы
- Шифрование чувствительной информации
- Контроль пользователя над собираемыми данными

#### 2.2. Анонимизация
- Удаление идентифицирующей информации при сборе статистики
- Агрегирование данных для анализа трендов
- Опциональное участие в улучшении моделей

### 3. Ограничения технологии

#### 3.1. Известные ограничения
- Невозможность 100% точности предсказаний
- Зависимость от качества распознавания игрового интерфейса
- Ограничения производительности в браузерной среде

#### 3.2. Коммуникация ограничений
- Честное информирование пользователя о возможностях системы
- Указание уровня уверенности в рекомендациях
- Предупреждения о потенциальных ошибках

## Дорожная карта развития ML-компонента

### 1. Первая версия (MVP)
- Базовые модели для рекомендаций во время боя
- Простой анализ колод
- Минимальный набор данных о картах

### 2. Расширенная версия
- Улучшенные модели с персонализацией
- Полноценный конструктор колод
- Базовый рыночный анализ

### 3. Полная версия
- Комплексная система рекомендаций
- Продвинутая аналитика и визуализация
- Интеграция с сообществом для обмена стратегиями

### 4. Будущие направления
- Федеративное обучение для улучшения моделей
- Поддержка турнирных режимов и специальных событий
- Интеграция с другими инструментами сообщества

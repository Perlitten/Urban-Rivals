<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Urban Rivals ML Extension</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #00ff88;
        }
        
        .btn {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #00ff88;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin: 5px;
        }
        
        .status.success { background: #00ff88; color: #000; }
        .status.error { background: #ff4444; color: #fff; }
        .status.warning { background: #ffaa00; color: #000; }
        .status.info { background: #4488ff; color: #fff; }
        
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        .check-pass { border-left: 4px solid #00ff88; }
        .check-fail { border-left: 4px solid #ff4444; }
        .check-unknown { border-left: 4px solid #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Urban Rivals ML Extension</h1>
        
        <div class="test-section">
            <h3>üìã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
            <button class="btn" onclick="runFullDiagnostics()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
            <div id="diagnosticsResult"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç –ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è</h3>
            <button class="btn" onclick="findExtension()">üîç –ù–∞–π—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ</button>
            <div id="extensionResult"></div>
        </div>
        
        <div class="test-section">
            <h3>‚ö° –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</h3>
            <button class="btn" onclick="testBasicFunctionality()" id="basicTestBtn" disabled>üì° –¢–µ—Å—Ç PING</button>
            <button class="btn" onclick="testMLStatus()" id="mlStatusBtn" disabled>ü§ñ –°—Ç–∞—Ç—É—Å ML</button>
            <div id="basicTestResult"></div>
        </div>
        
        <div class="test-section">
            <h3>üß™ –¢–µ—Å—Ç ML Workers</h3>
            <button class="btn" onclick="testMLWorkers()" id="mlTestBtn" disabled>üß† –¢–µ—Å—Ç ML –∞–Ω–∞–ª–∏–∑–∞</button>
            <div id="mlTestResult"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <button class="btn" onclick="showSystemInfo()">‚ÑπÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
            <div id="systemInfo"></div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã –æ–±—É—á–µ–Ω–∏—è</h3>
            <p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:</p>
            <button class="btn" onclick="copyTrainCommand()">üìã npm run train:ml</button>
            <button class="btn" onclick="copyStatusCommand()">üìã npm run ml:status</button>
            <div id="copyMessage"></div>
        </div>
    </div>

    <script>
        let EXTENSION_ID = null;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        async function runFullDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            resultDiv.innerHTML = '<h4>üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞...</h4>';
            
            const checks = [];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            try {
                await findExtension(false);
                checks.push({
                    name: '–ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è',
                    status: EXTENSION_ID ? 'pass' : 'fail',
                    message: EXTENSION_ID ? `–ù–∞–π–¥–µ–Ω–æ: ${EXTENSION_ID}` : '–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
                });
            } catch (error) {
                checks.push({
                    name: '–ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è',
                    status: 'fail',
                    message: `–û—à–∏–±–∫–∞: ${error.message}`
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: PING —Ç–µ—Å—Ç
            if (EXTENSION_ID) {
                try {
                    const pingResult = await sendMessageToExtension({type: 'PING'});
                    checks.push({
                        name: 'PING —Ç–µ—Å—Ç',
                        status: pingResult && pingResult.pong ? 'pass' : 'fail',
                        message: pingResult ? JSON.stringify(pingResult) : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞'
                    });
                } catch (error) {
                    checks.push({
                        name: 'PING —Ç–µ—Å—Ç',
                        status: 'fail',
                        message: `–û—à–∏–±–∫–∞: ${error.message}`
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: ML —Å—Ç–∞—Ç—É—Å
                try {
                    const mlStatus = await sendMessageToExtension({type: 'GET_ML_STATUS'});
                    checks.push({
                        name: 'ML —Å–∏—Å—Ç–µ–º–∞',
                        status: mlStatus && mlStatus.mlLoaded ? 'pass' : 'warning',
                        message: mlStatus ? `ML –∑–∞–≥—Ä—É–∂–µ–Ω: ${mlStatus.mlLoaded}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                    });
                } catch (error) {
                    checks.push({
                        name: 'ML —Å–∏—Å—Ç–µ–º–∞',
                        status: 'fail',
                        message: `–û—à–∏–±–∫–∞: ${error.message}`
                    });
                }
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            let html = '<h4>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</h4><ul class="checklist">';
            checks.forEach(check => {
                const statusClass = check.status === 'pass' ? 'check-pass' : 
                                   check.status === 'fail' ? 'check-fail' : 'check-unknown';
                const statusIcon = check.status === 'pass' ? '‚úÖ' : 
                                  check.status === 'fail' ? '‚ùå' : '‚ö†Ô∏è';
                
                html += `<li class="${statusClass}">
                    ${statusIcon} <strong>${check.name}:</strong> ${check.message}
                </li>`;
            });
            html += '</ul>';
            
            const overallStatus = checks.every(c => c.status === 'pass') ? 'success' : 
                                 checks.some(c => c.status === 'pass') ? 'warning' : 'error';
            
            html += `<div class="status ${overallStatus}">
                –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å: ${overallStatus === 'success' ? '‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã' : 
                               overallStatus === 'warning' ? '‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã' : '‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏'}
            </div>`;
            
            resultDiv.innerHTML = html;
        }
        
        // –ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        async function findExtension(showResult = true) {
            const resultDiv = document.getElementById('extensionResult');
            if (showResult) resultDiv.innerHTML = 'üîç –ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è...';
            
            // –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö ID —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const possibleIds = [
                'jbmpnjhpfcbohpddcekklkhfhflmcdnn', // –ø—Ä–∏–º–µ—Ä ID
                'extension-id-placeholder'
            ];
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ chrome.management API
            try {
                const extensions = await chrome.management.getAll();
                const urbanRivalsExt = extensions.find(ext => 
                    ext.name.toLowerCase().includes('urban rivals') ||
                    ext.name.toLowerCase().includes('ml consultant')
                );
                
                if (urbanRivalsExt) {
                    EXTENSION_ID = urbanRivalsExt.id;
                    const result = `‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ Management API!<br>
                        <div class="result">
                        ID: ${EXTENSION_ID}<br>
                        –ù–∞–∑–≤–∞–Ω–∏–µ: ${urbanRivalsExt.name}<br>
                        –í–µ—Ä—Å–∏—è: ${urbanRivalsExt.version}<br>
                        –°—Ç–∞—Ç—É—Å: ${urbanRivalsExt.enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ'}
                        </div>`;
                    
                    if (showResult) resultDiv.innerHTML = result;
                    enableTestButtons();
                    return;
                }
            } catch (error) {
                console.log('Management API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
            }
            
            // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ ID
            for (const id of possibleIds) {
                try {
                    const response = await sendMessageToExtension({type: 'PING'}, id);
                    if (response && response.pong) {
                        EXTENSION_ID = id;
                        const result = `‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!<br>
                            <div class="result">
                            ID: ${EXTENSION_ID}<br>
                            –û—Ç–≤–µ—Ç: ${JSON.stringify(response, null, 2)}
                            </div>`;
                        
                        if (showResult) resultDiv.innerHTML = result;
                        enableTestButtons();
                        return;
                    }
                } catch (error) {
                    console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å ${id}:`, error);
                }
            }
            
            if (showResult) {
                resultDiv.innerHTML = `‚ùå –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!<br>
                    <div class="result">
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:<br>
                    ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ Chrome<br>
                    ‚Ä¢ –í–∫–ª—é—á–µ–Ω–æ<br>
                    ‚Ä¢ –°–æ–±—Ä–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (npm run build)<br>
                    ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –ø–∞–ø–∫–∏ dist/
                    </div>`;
            }
        }
        
        function enableTestButtons() {
            document.getElementById('basicTestBtn').disabled = false;
            document.getElementById('mlStatusBtn').disabled = false;
            document.getElementById('mlTestBtn').disabled = false;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        function sendMessageToExtension(message, extensionId = EXTENSION_ID) {
            return new Promise((resolve, reject) => {
                if (!extensionId) {
                    reject(new Error('Extension ID –Ω–µ –Ω–∞–π–¥–µ–Ω'));
                    return;
                }
                
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è'));
                }, 5000);
                
                chrome.runtime.sendMessage(extensionId, message, (response) => {
                    clearTimeout(timeout);
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else {
                        resolve(response);
                    }
                });
            });
        }
        
        // –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        async function testBasicFunctionality() {
            const resultDiv = document.getElementById('basicTestResult');
            resultDiv.innerHTML = 'üì° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PING...';
            
            try {
                const response = await sendMessageToExtension({type: 'PING'});
                resultDiv.innerHTML = `‚úÖ PING —Ç–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω!<br>
                    <div class="result">${JSON.stringify(response, null, 2)}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `‚ùå PING —Ç–µ—Å—Ç –Ω–µ—É–¥–∞—á–µ–Ω!<br>
                    <div class="result">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        // –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ ML
        async function testMLStatus() {
            const resultDiv = document.getElementById('basicTestResult');
            resultDiv.innerHTML = 'ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ML...';
            
            try {
                const response = await sendMessageToExtension({type: 'GET_ML_STATUS'});
                const status = response.mlLoaded ? '‚úÖ ML —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '‚ö†Ô∏è ML —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
                
                resultDiv.innerHTML = `${status}<br>
                    <div class="result">${JSON.stringify(response, null, 2)}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ML!<br>
                    <div class="result">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        // –¢–µ—Å—Ç ML Workers
        async function testMLWorkers() {
            const resultDiv = document.getElementById('mlTestResult');
            resultDiv.innerHTML = 'üß† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ML –∞–Ω–∞–ª–∏–∑–∞...';
            
            try {
                const testData = {
                    battleState: {
                        id: 'test_' + Date.now(),
                        playerCards: [
                            {id: '1', name: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞', power: 7, damage: 5, clan: 'Bangers', 
                             ability: 'Test', rarity: 'Common', level: 3, owned: true}
                        ],
                        opponentCards: [
                            {id: '2', name: '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫', power: 6, damage: 4, clan: 'All Stars',
                             ability: 'Test', rarity: 'Common', level: 3, owned: false}
                        ],
                        currentRound: 1,
                        playerLife: 14,
                        opponentLife: 14,
                        playerPills: 12,
                        opponentPills: 12,
                        gamePhase: 'selection',
                        history: []
                    }
                };
                
                const startTime = Date.now();
                const response = await sendMessageToExtension({
                    type: 'ANALYZE_BATTLE',
                    data: testData
                });
                const duration = Date.now() - startTime;
                
                if (response.status === 'success') {
                    resultDiv.innerHTML = `‚úÖ ML –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–µ–Ω! (${duration}ms)<br>
                        <div class="result">
                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–∞—Ä—Ç–∞: ${response.result.recommendedCard?.name || 'N/A'}<br>
                        –ü–∏–ª–ª—Å—ã: ${response.result.recommendedPills || 'N/A'}<br>
                        –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–±–µ–¥—ã: ${((response.result.winProbability || 0) * 100).toFixed(1)}%<br>
                        <details>
                            <summary>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç</summary>
                            <pre>${JSON.stringify(response, null, 2)}</pre>
                        </details>
                        </div>`;
                } else {
                    resultDiv.innerHTML = `‚ùå ML –∞–Ω–∞–ª–∏–∑ –Ω–µ—É–¥–∞—á–µ–Ω!<br>
                        <div class="result">${JSON.stringify(response, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ ML —Ç–µ—Å—Ç–∞!<br>
                    <div class="result">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        // –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        function showSystemInfo() {
            const resultDiv = document.getElementById('systemInfo');
            
            const info = {
                userAgent: navigator.userAgent,
                chrome: {
                    version: /Chrome\/([0-9.]+)/.exec(navigator.userAgent)?.[1] || 'Unknown',
                    platform: navigator.platform
                },
                extension: {
                    id: EXTENSION_ID,
                    found: !!EXTENSION_ID
                },
                timestamp: new Date().toISOString(),
                url: window.location.href
            };
            
            resultDiv.innerHTML = `<div class="result"><pre>${JSON.stringify(info, null, 2)}</pre></div>`;
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –æ–±—É—á–µ–Ω–∏—è
        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                const msg = document.getElementById('copyMessage');
                msg.textContent = `–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${text}`;
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + err);
            }
        }

        function copyTrainCommand() { copyText('npm run train:ml'); }
        function copyStatusCommand() { copyText('npm run ml:status'); }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnostics, 1000);
        });
    </script>
</body>
</html> 